<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<!--接口名称-->
<mapper namespace="com.gbq.docker.uiproject.mapper.NoticeMapper">

    <insert id="saveNotice">
         INSERT INTO user_notice ( id, title, content, type, sender, has_all )
        VALUES
            ( #{notice.id}, #{notice.title}, #{notice.content}, #{notice.type}, #{notice.sender}, #{notice.hasAll} )
    </insert>


    <insert id="saveNoticeDesc">
        INSERT INTO user_notice_desc ( id, notice_id, receive, has_read )
        VALUES
            ( #{noticeDesc.id}, #{noticeDesc.noticeId}, #{noticeDesc.receive}, #{noticeDesc.hasRead} )
    </insert>
    <update id="readNotice">
        UPDATE user_notice_desc
        SET has_read = TRUE
        <where>
            receive = #{userId}
            <foreach collection = "ids" item = "id" open= "and id in (" close= ") " separator=",">
                #{id}
            </foreach>
        </where>
    </update>
    <delete id="deleteNotice">
        DELETE from user_notice_desc
        <where>
            receive = #{userId}
            <foreach collection="ids" item="id" open="and id in (" close=") " separator=",">
                #{id}
            </foreach>
        </where>
    </delete>
    <select id="listUserNotice" resultType="com.gbq.docker.uiproject.domain.dto.NoticeDTO">
        SELECT
            n.title,
            n.content,
            n.type,
            n.sender,
            l.username AS senderName,
            n.has_all,
            n.create_date,
            d.*
        FROM
            user_notice  n
            LEFT JOIN user_notice_desc d ON n.id = d.notice_id
            LEFT JOIN sys_login AS l ON n.sender = l.id
        WHERE
        d.receive = #{userId}
        <if test = "type != null" >
            AND n.type = #{type}
        </if>
    </select>
    <select id="listUnReadIds" resultType="java.lang.String">
        SELECT d.id
        from user_notice AS n , user_notice_desc AS d
        WHERE
         n.id = d.notice_id
        AND d.has_read = false
        AND d.receive = #{uid}
        <if test="type != null" >
            AND n.type =1
        </if>
    </select>
    <select id="countUnread" resultType="java.lang.Integer">
        SELECT COUNT(*) from user_notice_desc where receive = #{uid} and has_read = false
    </select>
</mapper>
